# 限流配置示例

# 默认配置
default:
  # 默认限流算法: fixed_window | sliding_window | token_bucket
  algorithm: fixed_window
  # 是否启用限流
  enabled: true

# 全局限流（可选）
# 注意：全局限流触发不会记录违规（因为不是用户/IP的问题）
global:
  algorithm: sliding_window
  # 算法参数数组
  # - fixed_window/sliding_window: [limit, window]  例如: ["1000", "60s"]
  # - token_bucket: [capacity, rate]  例如: ["10", "1/s"]
  params: ["1000", "1m"]  # 每分钟1000次

# 限流规则列表（按顺序匹配）
# 以下展示了三种算法的使用方式
rules:
  # ==================== 算法示例 ====================
  
  # 示例1: 固定窗口算法 (fixed_window)
  # 适用场景: 简单的时间窗口限流，性能最好
  - name: "登录限流-固定窗口"
    path: /api/user/login
    method: POST
    by: ip
    algorithm: fixed_window
    params: ["10", "1m"]        # [limit, window] 每分钟最多10次
    record_violation: true
    violation_weight: 3

  # 示例2: 滑动窗口算法 (sliding_window)
  # 适用场景: 需要更精确的限流控制，避免突刺流量
  - name: "注册限流-滑动窗口"
    path: /api/user/register
    method: POST
    by: ip
    algorithm: sliding_window
    params: ["5", "5m"]         # [limit, window] 5分钟最多5次
    record_violation: true
    violation_weight: 3

  # 示例3: 令牌桶算法 (token_bucket)
  # 适用场景: 允许短时突发流量，但长期平均速率受限
  - name: "上传限流-令牌桶"
    path: /api/upload/*
    method: POST
    by: user
    algorithm: token_bucket
    params: ["10", "1/s"]       # [capacity, rate] 桶容量10，每秒1个令牌
    record_violation: true
    violation_weight: 2

  # 示例4: 使用默认算法（不指定algorithm字段）
  - name: "文章列表-默认算法"
    path: /api/article/list
    method: GET
    by: ip
    params: ["60", "1m"]
    record_violation: false     # 不记录违规（正常浏览行为）
    violation_weight: 0

  # ==================== 其他业务场景示例 ====================
  
  # 按用户限流示例 - 用户API
  - name: "用户API限流"
    path: /api/user/*
    # method: 不指定，表示匹配所有方法（GET/POST/PUT/DELETE等）
    by: user                    # 按用户ID限流
    params: ["100", "60s"]
    record_violation: false     # 不记录违规（正常用户可能高频使用）
    violation_weight: 0

  # 不记录违规示例 - 文章列表
  - name: "文章列表限流"
    path: /api/article/list
    method: GET
    by: ip
    params: ["60", "60s"]
    record_violation: false     # 不记录违规（正常浏览行为）
    violation_weight: 0

  # 通配符路径示例 - OAuth回调
  - name: "OAuth回调限流"
    path: /api/auth/oauth/*/callback
    # method: 不指定，表示匹配所有方法（GET/POST/PUT/DELETE等）
    by: ip
    params: ["10", "60s"]
    record_violation: true
    violation_weight: 1

# 白名单配置
whitelist:
  # IP白名单（这些IP不受限流限制）
  ips:
    - 127.0.0.1
    - ::1
    # - 192.168.1.100

  # 用户白名单（这些用户不受限流限制）
  users:
    # - admin-user-uuid
    # - trusted-user-uuid

# 黑名单配置
blacklist:
  # IP黑名单（这些IP直接拒绝）
  ips:
    # - 192.168.1.100
    # - 10.0.0.50

  # 用户黑名单（这些用户直接拒绝）
  users:
    # - banned-user-uuid
    # - spammer-user-uuid

# 自动拉黑配置
auto_ban:
  # 是否启用自动拉黑
  enabled: true
  
  # 拉黑维度（可以同时启用多个）
  dimensions:
    - ip      # 按IP自动拉黑
    - user    # 按用户自动拉黑
  
  # 违规分数阈值（达到此分数自动拉黑）
  # 注意：这是累计分数，不同规则的violation_weight不同
  # 例如：登录限流触发3次(3×3=9分) + 搜索限流触发2次(2×1=2分) = 11分 → 拉黑
  violation_threshold: 10
  
  # 违规统计时间窗口（在此时间内累计违规分数）
  violation_window: 5m
  
  # 封禁时长（自动拉黑后的封禁时间）
  ban_duration: 1h
  
  # 说明：
  # - 全局限流触发不会记录违规（因为不是用户/IP的问题）
  # - 规则限流根据record_violation配置决定是否记录违规
  # - 违规分数 = Σ(触发次数 × violation_weight)
  # - 敏感接口（登录/注册）权重高(3分)，普通接口权重低(1分)
